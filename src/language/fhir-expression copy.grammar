@top Program { Expression }

@skip { whitespace }

Expression {
  TransformCall
| Reference
| FpExpression
}

/* ----------------- */
/* Transform calls   */
/* ----------------- */

TransformCall {
  Identifier "(" TransformArgs? ")"
}

TransformArgs {
  TransformArg (", " TransformArg)*
}

TransformArg {
  Reference
| Literal
}

/* ----------------- */
/* References        */
/* ----------------- */

Reference {
  Variable
| FieldAccess
}

Variable {
  Identifier
}

FieldAccess {
  Variable PropertyAccess+
}

PropertyAccess {
  "." Property
}

Property {
  Identifier
}

/* ----------------- */
/* Literals          */
/* ----------------- */

Literal {
  String
| Decimal
| Integer
| Boolean
}

/* ----------------- */
/* FpExpression      */
/* ----------------- */

FpExpression {
  FpTerm
}

FpTerm {
  FpInvocation
  | Literal
  | FpExternalConstant
  | '(' FpExpression ')'
}

FpExternalConstant {
  '%' ( Identifier | String )
}

FpInvocation {
  '$this'
  | '$index'
  | '$total'
}

/* ----------------- */
/* Tokens            */
/* ----------------- */

@tokens {

  @precedence { Decimal, Integer }

  Identifier { $[A-Za-z_]$[A-Za-z0-9_]* }

  String { '"' (!["\\] | "\\" _)* '"' }

  Decimal {
    $[0-9]* "." $[0-9]+
  }

  Integer {
    $[0-9]+
  }

  whitespace { $[ \t\n\r]+ }
}

Boolean { @specialize<Identifier, "true" | "false"> }
